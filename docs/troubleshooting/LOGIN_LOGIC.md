# 智能登录逻辑说明

## 🎯 设计目标

1. **无需每次选择**：记住用户的使用偏好
2. **自动进入**：有本地数据时直接进入本地模式
3. **灵活切换**：可以随时在本地模式和登录模式之间切换

## 🔄 工作流程

### 首次使用（无本地数据）

```
打开扩展
    ↓
检查是否有用户登录 → 无
    ↓
检查本地存储是否有数据 → 无
    ↓
显示登录选择页 ⭐
    ↓
用户选择：
├─ "使用 Google 账号登录" → 跳转到 Google 登录
└─ "稍后登录（使用本地存储）" → 进入本地模式
    ↓
保存选择到 localStorage
    ↓
下次自动应用此选择
```

### 已有本地数据

```
打开扩展
    ↓
检查是否有用户登录 → 无
    ↓
检查本地存储是否有数据 → 有 ⭐
    ↓
自动进入本地模式（无需选择） ✨
    ↓
直接显示内容列表
```

### 已登录用户

```
打开扩展
    ↓
检查是否有用户登录 → 有 ⭐
    ↓
自动使用数据库模式 ✨
    ↓
从 Supabase 加载数据
    ↓
显示内容列表
```

## 💾 状态保存机制

### localStorage 键值

| 键名 | 值 | 说明 |
|------|---|------|
| `qa_sider_use_local_mode` | `"true"` / `null` | 用户是否选择了本地模式 |

### 保存时机

1. **用户点击"稍后登录"** → 保存 `true`
2. **检测到本地有数据** → 自动保存 `true`
3. **用户登出** → 清除标记
4. **切换到登录模式** → 清除标记

## 🎨 用户界面

### 本地模式（游客模式）

**Header 显示：**
- 头像：圆形灰色图标，显示"游"字
- 用户名：游客模式
- 说明：数据保存在本地
- 按钮：**[登录]** 按钮（可切换到登录模式）

**副标题：**
> 本地模式：数据仅保存在浏览器

### 登录模式

**Header 显示：**
- 头像：Google 账号头像
- 用户名：Google 账号名称
- 邮箱：Google 邮箱
- 按钮：**[登出]** 按钮

**副标题：**
> 保存并同步您的代码片段

## 🔀 模式切换

### 从本地模式切换到登录模式

1. 点击 Header 右侧的 **[登录]** 按钮
2. 清除 localStorage 标记
3. 页面重新加载
4. 显示登录选择页
5. 选择"使用 Google 账号登录"
6. 完成 Google 登录
7. **自动迁移本地数据到云端** ✨

### 从登录模式退出

1. 点击 Header 右侧的 **[登出]** 按钮
2. 退出 Google 登录
3. 清除 localStorage 标记
4. 页面重新加载
5. 检查本地是否有数据
   - 有数据 → 自动进入本地模式
   - 无数据 → 显示登录选择页

## 📊 决策流程图

```
┌─────────────────┐
│   打开扩展      │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│ 检查用户登录？  │
└────┬─────────┬──┘
     │是       │否
     ↓         ↓
┌─────────┐  ┌──────────────────┐
│数据库模式│  │ 检查 localStorage │
│自动加载  │  │ use_local_mode?  │
└─────────┘  └────┬──────────┬──┘
                  │true      │null
                  ↓          ↓
            ┌─────────┐  ┌─────────────┐
            │本地模式  │  │ 检查本地数据│
            │自动加载  │  └────┬─────┬──┘
            └─────────┘       │有   │无
                              ↓     ↓
                        ┌─────────┐ ┌─────────┐
                        │本地模式  │ │登录选择页│
                        │自动加载  │ └─────────┘
                        └─────────┘
```

## 🔒 数据安全

### 本地模式
- ✅ 数据存储在 Chrome Storage Local
- ✅ 仅在当前浏览器可访问
- ⚠️ 清除浏览器数据会丢失
- ⚠️ 无法跨设备同步

### 登录模式
- ✅ 数据存储在 Supabase 云端
- ✅ 多设备自动同步
- ✅ 数据永久保存
- ✅ 可以从任何设备访问

## 🎁 自动数据迁移

当用户从本地模式切换到登录模式时：

1. 用户点击"登录"按钮
2. 完成 Google 登录
3. `useAuth` hook 检测到新用户登录
4. 自动触发 `migrateLocalDataToSupabase()`
5. 将所有本地数据上传到 Supabase
6. 迁移完成后显示提示
7. 后续使用云端数据

**迁移逻辑**（在 `src/hooks/useAuth.ts`）：
- 只在首次登录时触发一次
- 使用 `hasMigrated` ref 防止重复迁移
- 迁移失败不影响正常使用
- 错误会记录到控制台

## 🧪 测试场景

### 场景 1：全新用户
1. 首次安装扩展
2. 打开扩展 → 看到登录选择页
3. 选择"稍后登录" → 进入本地模式
4. 创建几条内容
5. 关闭并重新打开 → **直接进入本地模式** ✅
6. 看到之前创建的内容

### 场景 2：已有本地数据
1. 已使用本地模式并创建了内容
2. 关闭扩展
3. 重新打开 → **直接进入本地模式** ✅
4. 无需选择，直接看到内容

### 场景 3：切换到登录
1. 在本地模式下
2. 点击 Header 的"登录"按钮
3. 页面重新加载 → 显示登录选择页
4. 点击"使用 Google 账号登录"
5. 完成登录 → 本地数据自动迁移到云端
6. 后续打开 → 自动进入登录模式

### 场景 4：登出
1. 在登录模式下
2. 点击"登出"按钮
3. 退出登录，清除标记
4. 页面重新加载
5. 检查本地数据：
   - 有数据 → 进入本地模式
   - 无数据 → 显示登录选择页

### 场景 5：多设备使用
1. 设备 A：使用 Google 登录
2. 设备 B：使用同一 Google 账号登录
3. 两个设备自动同步数据 ✅

## 💡 最佳实践

### 推荐使用方式

**个人使用（单设备）：**
- 使用本地模式即可
- 快速、简单、无需配置

**多设备同步：**
- 使用 Google 登录
- 所有设备自动同步
- 数据永久保存

**先试用后登录：**
1. 初次使用选择"稍后登录"
2. 试用一段时间
3. 觉得好用后点击"登录"
4. 本地数据自动迁移到云端

## 🐛 故障排查

### 问题：每次打开都要选择

**可能原因：**
- localStorage 被清除
- 本地没有数据

**解决方案：**
1. 创建至少一条内容
2. 或手动在控制台执行：
```javascript
localStorage.setItem('qa_sider_use_local_mode', 'true');
```

### 问题：切换到登录后数据丢失

**说明：**
- 这是正常行为
- 登录后会从 Supabase 加载数据
- 本地数据会自动迁移到云端

**如果迁移失败：**
1. 检查网络连接
2. 查看控制台错误信息
3. 手动重新登录触发迁移

### 问题：想清除所有数据重新开始

```javascript
// 在控制台执行
localStorage.removeItem('qa_sider_use_local_mode');
chrome.storage.local.clear();
location.reload();
```
